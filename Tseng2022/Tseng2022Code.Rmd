---
title: "Posvirus Host Prediction"
author: "Katie Tseng, Dan Becker, Heather Koehler, Pilar Fernandez, Stephanie Seifert"
output:
  pdf_document:
  latex_engine: xelatex
  toc: yes
html_document:
  fig_height: 6
  fig_width: 6
  highlight: tango
  theme: journal
---

```{r, echo=F, message=F}
knitr::opts_chunk$set(eval=F)
```

# Introduction

The following code reproduces the analysis from:

> etc.

# Set system

```{r echo=F, message=T}

#clean environment
rm(list=ls()) 
graphics.off()

#set working directory
setwd("~/Library/CloudStorage/OneDrive-WashingtonStateUniversity(email.wsu.edu)/Fernandez Lab/Projects (Active)/OPV Host Prediction/GitHub/PoxHost/Tseng2022")

```

# Load required packages

```{r echo=F, message=T}

library(ape)
library(dplyr)
library(nlme)
library(tidyverse)
library(vroom)
library(treespace) #note: treespace dependencies include XQuartz v2.7.11 and package 'rgl' (https://stackoverflow.com/a/66127391/2554330)
    #1. install XQuartz v2.7.11 (https://www.xquartz.org/releases/XQuartz-2.7.11.html); 
    #2. install package 'rgl': >install.packages ("rgl") \ >options(rgl.useNULL=TRUE) \ >.rs.restartR() \ >library(rgl)

## for modeling
library(gbm);
library(ROCR);
library(vegan);
library(plyr);library(dplyr);
library(mvtnorm)
library(xtable)
library(parallel)

```

# Load interaction data

```{r echo=F, message=T}

## (1) load data
load("Tseng2022.RData")
  #combine (hostTraits): mammal traits from combine database, <https://doi.org/10.1002/ecy.3344> (file: "trait_data_imputed.csv")
  #dryad (phylo tree): mammal phylogeny tree from Dryad, <https://doi.org/10.5061/dryad.tb03d03> (path: "Data_S8_finalFigureFiles">"_DATA")
  #opvgenes (virusTraits):
  #vertlife (taxa): mammal species taxonomy from vertlife, <https://data.vertlife.org/>
  #virion (poxdata): host-virus paired interactions from virion, <https://github.com/viralemergence/virion/tree/main/Virion> 

```

# Obtain host-poxvirus interaction data

```{r echo=F, message=T}

## (1) extract host-OPV interactions detected via PCR or isolation from virion
poxdata <- virion %>%
  filter(VirusGenus == "orthopoxvirus" & (DetectionMethod %in% c("PCR/Sequencing","Isolation/Observation"))) 

## (2) exclude if host genus or virus is NA and if variola virus
poxdata <- poxdata[!is.na(poxdata$HostGenus),]
poxdata <- poxdata[!is.na(poxdata$Virus),]
poxdata <- poxdata[!(poxdata$Virus=="variola virus"),]

## (3) to dis-aggregate West African from Congo Basin MPXV clades, subset MPXV interactions, export, and merge clade data into poxdata
mpxvdata <- poxdata %>% filter(Virus=="monkeypox virus" & (DetectionMethod %in% c("PCR/Sequencing","Isolation/Observation")))
#write.csv(mpxvdata, "~/mpxvdata.csv")

## (4)

## (5) separate PCR-positive data where host species is not NA
pcr <- subset(poxdata[which(poxdata$DetectionMethod=="PCR/Sequencing"),], select=c("Host","HostGenus","Virus"))
pcr$Host <- ifelse(is.na(pcr$Host),"sp.",pcr$Host)
pcr$pstudies <- 1
pcr <- aggregate(.~Host+HostGenus+Virus, data=pcr, sum)

## (6) separate isolation-positive data
competence <- subset(poxdata[which(poxdata$DetectionMethod=="Isolation/Observation"),], select=c("Host","HostGenus","Virus"))
competence$Host <- ifelse(is.na(competence$Host),"sp.",competence$Host)
competence$cstudies <- 1
competence <- aggregate(.~Host+HostGenus+Virus, data=competence, sum)

## (7) merge PCR/isolation-positive data; create binary vars
poxdata <- merge(pcr, competence, by=c("Host","HostGenus","Virus"), all=TRUE)
poxdata$pcr=ifelse(is.na(poxdata$pstudies),0,1)
poxdata$competence=ifelse(is.na(poxdata$cstudies),0,1)

## (8) combine studies into single variable
poxdata$studies <- ifelse(is.na(poxdata$pstudies),0,poxdata$pstudies) + ifelse(is.na(poxdata$cstudies),0,poxdata$cstudies)
poxdata$pstudies=NULL
poxdata$cstudies=NULL

## (9) aggregate at genus level and sum the number of studies
agg_sum <- subset(poxdata, select=c(HostGenus,Virus,studies))
agg_sum <- aggregate(.~HostGenus+Virus, data=agg_sum, sum)

## (10) aggregate at genus level and take max value of pcr and competence (binary)
agg_max <- subset(poxdata,select=c(HostGenus,Virus,pcr,competence))
agg_max <- aggregate(.~HostGenus+Virus, data=agg_max, max)

## (11) remove records in which host species is unknown
poxdata <- subset(poxdata, poxdata$Host!="sp.", select=c("Host","HostGenus","Virus"))

## (12) merge count data
poxdata <- merge(poxdata,agg_sum)
poxdata <- merge(poxdata,agg_max)

## (8) capitalize genus
poxdata$gen <- str_to_title(poxdata$HostGenus)
poxdata$HostGenus=NULL

## (8) clean environment
rm(virion,pcr,competence,agg_max,agg_sum,mpxvdata)

```

# Merge taxonomy data

```{r echo=F, message=T}

## (1) simplify taxa to genus-level
taxa <- vertlife
gtaxa=taxa[!duplicated(taxa$gen),]
gtaxa=gtaxa[c('gen','fam','ord','clade','higher')]

## (2) check for mismatched names, then merge
poxdata$gen[!poxdata$gen %in% taxa$gen]
poxdata=merge(gtaxa,poxdata,by='gen',all.x=TRUE)

## (3) create binary var for sampled vs. unsampled
poxdata$sampled=ifelse(is.na(poxdata$pcr) & is.na(poxdata$competence),0,1)

## (4) create pseudo-absences for viral detection
poxdata$pcr=ifelse(is.na(poxdata$pcr),0,poxdata$pcr)
poxdata$competence=ifelse(is.na(poxdata$competence),0,poxdata$competence)

## (5) keep only genera from orders in which positive associations exist
keep=subset(poxdata, pcr==1 | competence==1)
poxdata$keep=ifelse(poxdata$ord %in% keep$ord,TRUE,FALSE)
poxdata=subset(poxdata,keep==TRUE)
poxdata$keep=NULL

## (6) create unique combinations of OPV species and all mammal genera that exist in orders w/ known OPV predictions
uniq_gen <- unique(poxdata$gen[!is.na(poxdata$gen)])
uniq_virus <- unique(poxdata$Virus[!is.na(poxdata$Virus)])
data <- expand.grid(uniq_gen,uniq_virus)
data <- rename(data,c('Var1'='gen','Var2'='Virus'))
data <- merge(data,poxdata,all.x=TRUE)

## (7) check that duplicates are due to associations for multiple species within a genera
data$dup <- ifelse(duplicated(data[,1:2]),1,0)

## (6) clean environment
rm(poxdata,taxa,gtaxa,keep,uniq_gen,uniq_virus)

```

# Merge viral accessory genes

```{r echo=F, message=T}

## (1) clean data
viralTraits <- opvgenes
viralTraits <- head(viralTraits, -2)          

## (2) rename column names
original_cols <- colnames(viralTraits)
colnames(viralTraits) <- paste("ag" ,original_cols,sep="_")
names(viralTraits)[1:2] <- c("virus","OPG")

## (3) to assess variation in viralTraits, create mode function
mode.prop <- function(x) {                
  ux <- unique(x[is.na(x)==FALSE])        # creates array of unique values
  tab <- tabulate(match(na.omit(x), ux))  # creates array of the frequency (number of times) a unique value appears in a column 
  max(tab)/length(x[is.na(x)==FALSE])     # max-frequency / number of elements in each column that are not NA
}

## (4) assess variation across columns (2 indicates columns)
vars=data.frame(apply(viralTraits,2,function(x) mode.prop(x)),
                apply(viralTraits,2,function(x) length(unique(x))))    # number of unique elements in each column
vars$variables=rownames(vars)
colnames(vars) <- c("var","uniq","column")

## trim
#vars <- vars[-c(1,2), ]

## drop variables with no variation
vars <- subset(vars,vars$var<1)

## visualize distribution of NA
png("/Users/katietseng/Downloads/virus_ag_variation.png", width=4,height=4,units="in",res=600)
ggplot(vars,
       aes(var))+
  geom_histogram(bins=50)+
  geom_vline(xintercept=0.70,linetype=2,size=0.5)+
  theme_bw()+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank())+
  theme(axis.title.x=element_text(margin=margin(t=10,r=0,b=0,l=0)))+
  theme(axis.title.y=element_text(margin=margin(t=0,r=10,b=0,l=0)))+
  labs(y="frequency",
       x="trait coverage across viral species")+
  scale_x_continuous(labels = scales::percent)
dev.off()

## drop based on threshold
vars$keep=ifelse(vars$var>=0.7,"keep","cut")
keeps=vars[-which(vars$keep=="cut"),]$column #creates array of column names to cut and removes from df
keeps <- append(keeps,"virus")
viralTraits=viralTraits[keeps]
#rm(keeps,vars,mode.prop,original_cols)

# ## drop if not well represented
# data=data[keeps]
# rm(keeps,mval)

## identify rows with duplicate values
which(duplicated(viralTraits[,-c(1,2)])| duplicated(viralTraits[,-c(1,2)], fromLast = TRUE))

```


# Aggregate at genus level

```{r echo=F, message=T}
# pox_data <- virion
# taxa <- vertlife
# host_traits <- combine
# virus_traits <- opvgenes
# tree <- dryad
```

# Combine PubMed citations and evolutionary distinctiveness measure

```{r echo=F, message=T}
```

# Phylogenetic analysis

```{r echo=F, message=T}

# 02_phylofactor.R

```

# Inspect and format data for inclusion in the model

```{r echo=F, message=T}

```

# 

```{r echo=F, message=T}
```

# 

```{r echo=F, message=T}
```

# 

```{r echo=F, message=T}
```

# 